<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradutor de Documentos - Multi-API</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            padding: 48px;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 48px;
            color: #1d1d1f;
        }

        .api-selector {
            background: #f5f5f7;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .api-selector h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #1d1d1f;
        }

        .api-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .api-option {
            padding: 16px;
            border: 2px solid #d2d2d7;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .api-option:hover {
            border-color: #86868b;
            background: #fafafa;
        }

        .api-option.selected {
            border-color: #0071e3;
            background: #e8f2ff;
        }

        .api-option h4 {
            font-size: 16px;
            margin-bottom: 4px;
            color: #1d1d1f;
        }

        .api-option p {
            font-size: 14px;
            color: #86868b;
            margin: 0;
        }

        .api-key-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            background: #f5f5f7;
            transition: all 0.2s;
        }

        input[type="password"]:focus {
            outline: none;
            border-color: #0071e3;
            background: white;
        }

        input[type="password"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .language-selector {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            margin-bottom: 32px;
        }

        select {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }

        .help-text {
            font-size: 14px;
            color: #86868b;
            margin-top: 8px;
        }

        select:focus {
            outline: none;
            border-color: #0071e3;
        }

        .arrow {
            font-size: 20px;
            color: #86868b;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #d2d2d7;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 24px;
            background: #f5f5f7;
        }

        .upload-area:hover {
            border-color: #86868b;
            background: #ebebed;
        }

        .upload-area.dragover {
            border-color: #0071e3;
            background: #e8f2ff;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 8px;
            color: #86868b;
        }

        .upload-text {
            color: #1d1d1f;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .upload-formats {
            color: #86868b;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            background: #f5f5f7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .file-name {
            color: #1d1d1f;
            font-weight: 500;
        }

        .remove-file {
            background: none;
            border: none;
            color: #0071e3;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .remove-file:hover {
            background: #e8f2ff;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            font-size: 16px;
            font-family: inherit;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            background: #f5f5f7;
            resize: vertical;
            transition: all 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #0071e3;
            background: white;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #86868b;
            margin-top: 8px;
            margin-bottom: 32px;
        }

        .button {
            width: 100%;
            padding: 16px 32px;
            font-size: 17px;
            font-weight: 500;
            color: white;
            background: #0071e3;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 32px;
        }

        .button:hover:not(:disabled) {
            background: #0077ed;
        }

        .button:disabled {
            background: #86868b;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 32px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .loading p {
            margin: 10px 0;
            color: #495057;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f5f5f7;
            border-top-color: #0071e3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .windows-container {
            display: none;
            margin-bottom: 32px;
        }

        .windows-container.show {
            display: block;
        }

        .window-header {
            background: #f5f5f7;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .window-header h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .window-header p {
            font-size: 14px;
            color: #86868b;
            margin: 0;
        }

        .translation-window {
            background: white;
            border: 2px solid #d2d2d7;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .window-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .window-title {
            font-size: 16px;
            font-weight: 600;
        }

        .window-status {
            font-size: 14px;
            padding: 4px 12px;
            border-radius: 12px;
            background: #f5f5f7;
        }

        .window-status.pending {
            background: #f5f5f7;
            color: #86868b;
        }

        .window-status.processing {
            background: #fff3cd;
            color: #856404;
        }

        .window-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .window-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .window-preview {
            background: #f5f5f7;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #86868b;
            max-height: 100px;
            overflow: hidden;
        }

        .window-actions {
            display: flex;
            gap: 12px;
        }

        .window-button {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .window-button.primary {
            background: #0071e3;
            color: white;
        }

        .window-button.primary:hover:not(:disabled) {
            background: #0077ed;
        }

        .window-button.secondary {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .window-button.secondary:hover:not(:disabled) {
            background: #e8e8ed;
        }

        .window-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f5f5f7;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: #0071e3;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-details {
            text-align: center;
            font-size: 14px;
            color: #86868b;
            margin-top: 10px;
            display: none;
        }

        .progress-details.show {
            display: block;
        }

        .error {
            background: #fff5f5;
            border: 1px solid #ff3b30;
            color: #ff3b30;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .warning {
            background: #fffbf0;
            border: 1px solid #ff9500;
            color: #ff9500;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
        }

        .warning.show {
            display: block;
        }

        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .result-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .result-actions {
            display: flex;
            gap: 12px;
        }

        .small-button {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-button {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .copy-button:hover {
            background: #e8e8ed;
        }

        .download-menu {
            position: relative;
            display: inline-block;
        }

        .download-options {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 8px;
            min-width: 150px;
            right: 0;
            top: 100%;
            margin-top: 4px;
            z-index: 10;
        }

        .download-options.show {
            display: block;
        }

        .download-option {
            display: block;
            padding: 8px 12px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            color: #1d1d1f;
            transition: background 0.2s;
        }

        .download-option:hover {
            background: #f5f5f7;
        }

        .result-text {
            background: #f5f5f7;
            border-radius: 8px;
            padding: 24px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 16px;
            line-height: 1.6;
        }

        .result-info {
            text-align: right;
            font-size: 14px;
            color: #86868b;
            margin-top: 8px;
        }

        footer {
            text-align: center;
            margin-top: 48px;
            padding-top: 24px;
            border-top: 1px solid #d2d2d7;
            color: #86868b;
            font-size: 14px;
        }

        footer a {
            color: #0071e3;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .container {
                padding: 32px 24px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 32px;
            }

            .language-selector {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .arrow {
                transform: rotate(90deg);
            }

            .api-key-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tradutor de Documentos Multi-API</h1>

        <!-- Seletor de API -->
        <div class="api-selector">
            <h3>Escolha a API de tradu√ß√£o:</h3>
            <div class="api-options">
                <div class="api-option selected" data-provider="anthropic" data-model="claude-3-5-sonnet-20241022">
                    <h4>Claude 3.5 Sonnet</h4>
                    <p>Melhor qualidade ‚Ä¢ 5-15s</p>
                </div>
                <div class="api-option" data-provider="openai" data-model="gpt-4o">
                    <h4>GPT-4o</h4>
                    <p>R√°pido e bom ‚Ä¢ 2-4s</p>
                </div>
                <div class="api-option" data-provider="openai" data-model="gpt-3.5-turbo">
                    <h4>GPT-3.5 Turbo</h4>
                    <p>Mais r√°pido ‚Ä¢ 1-2s</p>
                </div>
            </div>
        </div>

        <!-- Chaves API -->
        <div class="api-key-section">
            <div class="form-group">
                <label for="anthropicKey">Chave API Anthropic</label>
                <input 
                    type="password" 
                    id="anthropicKey" 
                    placeholder="sk-ant-api03-..." 
                    autocomplete="off"
                >
            </div>
            <div class="form-group">
                <label for="openaiKey">Chave API OpenAI</label>
                <input 
                    type="password" 
                    id="openaiKey" 
                    placeholder="sk-..." 
                    autocomplete="off"
                >
            </div>
        </div>

        <div class="language-selector">
            <div>
                <label for="sourceLang">Idioma de origem</label>
                <select id="sourceLang">
                    <option value="auto">Detectar automaticamente</option>
                    <option value="pt-BR">Portugu√™s (Brasil)</option>
                    <option value="pt-PT">Portugu√™s (Portugal)</option>
                    <option value="en">Ingl√™s</option>
                    <option value="es">Espanhol</option>
                    <option value="fr">Franc√™s</option>
                    <option value="de">Alem√£o</option>
                    <option value="it">Italiano</option>
                    <option value="ja">Japon√™s</option>
                    <option value="ko">Coreano</option>
                    <option value="zh">Chin√™s</option>
                </select>
            </div>
            <div class="arrow">‚Üí</div>
            <div>
                <label for="targetLang">Idioma de destino</label>
                <select id="targetLang">
                    <option value="pt-BR" selected>Portugu√™s (Brasil)</option>
                    <option value="pt-PT">Portugu√™s (Portugal)</option>
                    <option value="en">Ingl√™s</option>
                    <option value="es">Espanhol</option>
                    <option value="fr">Franc√™s</option>
                    <option value="de">Alem√£o</option>
                    <option value="it">Italiano</option>
                    <option value="ja">Japon√™s</option>
                    <option value="ko">Coreano</option>
                    <option value="zh">Chin√™s</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="style">Estilo de tradu√ß√£o</label>
            <select id="style">
                <option value="intelligent" selected>Inteligente (Recomendada)</option>
                <option value="faithful">Fiel ao Original</option>
                <option value="fluent">Fluente e Natural</option>
                <option value="creative">Criativa e Liter√°ria</option>
                <option value="simplified">Simplificada</option>
                <option value="formal">Formal e Profissional</option>
                <option value="informal">Informal e Casual</option>
            </select>
            <p class="help-text" style="font-size: 14px; color: #86868b; margin-top: 8px;">
                üí° Inteligente: Captura TODOS os significados e transp√µe perfeitamente estilo, contexto e express√µes
            </p>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÑ</div>
            <p class="upload-text">Arraste um arquivo ou clique para selecionar</p>
            <p class="upload-formats">PDF, TXT, DOCX ‚Ä¢ M√°ximo 50MB</p>
            <input type="file" id="fileInput" accept=".pdf,.txt,.docx,.doc">
        </div>

        <div class="file-info" id="fileInfo">
            <span class="file-name" id="fileName"></span>
            <button class="remove-file" id="removeFileBtn">Remover</button>
        </div>

        <div class="form-group">
            <label for="textInput">Ou insira seu texto aqui</label>
            <textarea 
                id="textInput" 
                placeholder="Cole ou digite o texto que deseja traduzir..."
            ></textarea>
            <div class="char-count">
                <span id="charCount">0</span> caracteres
            </div>
        </div>

        <button class="button" id="translateButton">
            Traduzir
        </button>

        <!-- Container para modo janelas -->
        <div class="windows-container" id="windowsContainer">
            <div class="window-header">
                <h3>Modo Texto Grande Ativado</h3>
                <p id="windowsInfo"></p>
            </div>
            <div id="windowsList"></div>
            <div style="margin-top: 24px; display: flex; gap: 12px;">
                <button class="window-button primary" onclick="downloadAllWindows()">
                    üì• Baixar Todas as Tradu√ß√µes
                </button>
                <button class="window-button secondary" onclick="joinAllTranslations()">
                    üîó Juntar Tradu√ß√µes
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Traduzindo...</p>
            <p style="font-size: 14px; color: #86868b;">
                <span id="progressText"></span>
            </p>
        </div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-details" id="progressDetails"></div>

        <div class="error" id="error"></div>
        <div class="warning" id="warning"></div>

        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h3 class="result-title">Tradu√ß√£o</h3>
                <div class="result-actions">
                    <button class="small-button copy-button" id="copyBtn">
                        Copiar
                    </button>
                    <div class="download-menu">
                        <button class="small-button download-button" id="downloadBtn" style="background: #0071e3; color: white;">
                            Baixar ‚ñº
                        </button>
                        <div class="download-options" id="downloadOptions">
                            <button class="download-option" onclick="downloadHTML()">
                                üìÑ HTML Formatado
                            </button>
                            <button class="download-option" onclick="downloadMarkdown()">
                                üìù Markdown
                            </button>
                            <button class="download-option" onclick="downloadTXT()">
                                üìÉ Texto Simples
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="result-text" id="resultText"></div>
            <div class="result-info" id="resultInfo"></div>
        </div>

        <footer>
            Powered by <a href="https://www.anthropic.com" target="_blank">Anthropic Claude</a> & <a href="https://openai.com" target="_blank">OpenAI</a>
        </footer>
    </div>

    <script>
        // Configura√ß√£o do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let extractedText = '';
        let translatedText = '';
        let currentFileName = '';
        let translationStartTime = 0;
        let abortController = null;
        let selectedProvider = 'anthropic';
        let selectedModel = 'claude-3-5-sonnet-20241022';
        
        // Sistema de janelas
        let windowsMode = false;
        let textWindows = [];
        let windowTranslations = {};

        // Configura√ß√£o de chunk size por provider
        const CHUNK_SIZES = {
            'anthropic': 2000,
            'openai': {
                'gpt-4o': 3000,
                'gpt-3.5-turbo': 4000
            }
        };

        // Tamanho m√°ximo para modo janela
        const WINDOW_SIZE = 20000;

        // Seletor de API
        document.querySelectorAll('.api-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.api-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedProvider = option.dataset.provider;
                selectedModel = option.dataset.model;
                
                // Atualizar estado dos campos de API key
                updateApiKeyFields();
            });
        });

        function updateApiKeyFields() {
            const anthropicField = document.getElementById('anthropicKey');
            const openaiField = document.getElementById('openaiKey');
            
            if (selectedProvider === 'anthropic') {
                anthropicField.disabled = false;
                openaiField.disabled = true;
            } else {
                anthropicField.disabled = true;
                openaiField.disabled = false;
            }
        }

        // Atualizar contador de caracteres
        document.getElementById('textInput').addEventListener('input', updateCharCount);

        function updateCharCount() {
            const text = document.getElementById('textInput').value;
            const charCount = text.length;
            document.getElementById('charCount').textContent = charCount.toLocaleString('pt-BR');
            
            // Estimativa de tempo baseada no provider
            let timeEstimate = '';
            if (charCount > 0) {
                if (selectedProvider === 'openai' && selectedModel === 'gpt-3.5-turbo') {
                    // GPT-3.5 √© muito r√°pido
                    if (charCount <= 10000) timeEstimate = ' ‚Ä¢ ~10 segundos';
                    else if (charCount <= 50000) timeEstimate = ' ‚Ä¢ ~1 minuto';
                    else timeEstimate = ' ‚Ä¢ ~2-3 minutos';
                } else if (selectedProvider === 'openai') {
                    // GPT-4o
                    if (charCount <= 10000) timeEstimate = ' ‚Ä¢ ~20 segundos';
                    else if (charCount <= 50000) timeEstimate = ' ‚Ä¢ ~2 minutos';
                    else timeEstimate = ' ‚Ä¢ ~5 minutos';
                } else {
                    // Claude
                    if (charCount <= 10000) timeEstimate = ' ‚Ä¢ ~1 minuto';
                    else if (charCount <= 50000) timeEstimate = ' ‚Ä¢ ~5 minutos';
                    else timeEstimate = ' ‚Ä¢ ~10+ minutos';
                }
            }
            
            // Avisar sobre modo janela
            if (charCount > WINDOW_SIZE) {
                timeEstimate += ' ‚Ä¢ ü™ü Modo janela recomendado';
            }
            
            document.querySelector('.char-count').innerHTML = 
                `<span id="charCount">${charCount.toLocaleString('pt-BR')}</span> caracteres${timeEstimate}`;
        }

        // Configurar eventos dos bot√µes
        document.getElementById('translateButton').addEventListener('click', translate);
        document.getElementById('removeFileBtn').addEventListener('click', removeFile);
        document.getElementById('copyBtn').addEventListener('click', copyResult);
        
        // Menu de download
        document.getElementById('downloadBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('downloadOptions').classList.toggle('show');
        });

        // Fechar menu ao clicar fora
        document.addEventListener('click', function() {
            document.getElementById('downloadOptions').classList.remove('show');
        });

        // Configurar eventos de upload
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            // Validar tamanho do arquivo
            if (file.size > 50 * 1024 * 1024) {
                showError('Arquivo muito grande. O limite √© 50MB.');
                return;
            }

            // Validar tipo de arquivo
            const validTypes = ['application/pdf', 'text/plain', 
                               'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                               'application/msword'];
            
            if (!validTypes.includes(file.type) && !file.name.endsWith('.txt')) {
                showError('Tipo de arquivo n√£o suportado. Use PDF, TXT ou DOCX.');
                return;
            }

            currentFileName = file.name;
            showFileInfo(file.name);

            try {
                showLoading(true, 'Processando arquivo...');
                
                if (file.type === 'application/pdf') {
                    extractedText = await extractPDF(file);
                } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    extractedText = await extractTXT(file);
                } else if (file.type.includes('word') || file.name.endsWith('.docx')) {
                    extractedText = await extractDOCX(file);
                }

                document.getElementById('textInput').value = extractedText;
                updateCharCount();
                showLoading(false);
            } catch (error) {
                showError('Erro ao processar arquivo: ' + error.message);
                removeFile();
                showLoading(false);
            }
        }

        async function extractPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                showLoading(true, `Processando p√°gina ${i} de ${pdf.numPages}...`);
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // Melhor preserva√ß√£o de formata√ß√£o
                let lastY = null;
                let pageText = '';
                
                textContent.items.forEach(item => {
                    if (lastY !== null && Math.abs(lastY - item.transform[5]) > 5) {
                        pageText += '\n';
                    }
                    pageText += item.str + ' ';
                    lastY = item.transform[5];
                });
                
                fullText += pageText + '\n\n';
            }

            return fullText.trim();
        }

        async function extractTXT(file) {
            return await file.text();
        }

        async function extractDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        function showFileInfo(fileName) {
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileInfo').style.display = 'flex';
            document.getElementById('uploadArea').style.display = 'none';
        }

        function removeFile() {
            extractedText = '';
            currentFileName = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('textInput').value = '';
            fileInput.value = '';
            updateCharCount();
        }

        // Fun√ß√£o para dividir texto em janelas
        function createTextWindows(text, windowSize = WINDOW_SIZE) {
            const windows = [];
            const paragraphs = text.split(/\n\n+/);
            let currentWindow = '';
            let currentSize = 0;

            for (const paragraph of paragraphs) {
                if (currentSize + paragraph.length > windowSize && currentWindow) {
                    windows.push(currentWindow.trim());
                    currentWindow = paragraph;
                    currentSize = paragraph.length;
                } else {
                    currentWindow += (currentWindow ? '\n\n' : '') + paragraph;
                    currentSize += paragraph.length + 2;
                }
            }

            if (currentWindow) {
                windows.push(currentWindow.trim());
            }

            return windows;
        }

        // Mostrar janelas
        function showWindows(windows) {
            windowsMode = true;
            textWindows = windows;
            windowTranslations = {};

            const container = document.getElementById('windowsContainer');
            const list = document.getElementById('windowsList');
            const info = document.getElementById('windowsInfo');

            info.textContent = `Seu texto tem ${document.getElementById('textInput').value.length.toLocaleString('pt-BR')} caracteres e foi dividido em ${windows.length} janelas.`;

            list.innerHTML = '';

            windows.forEach((window, index) => {
                const windowDiv = document.createElement('div');
                windowDiv.className = 'translation-window';
                windowDiv.innerHTML = `
                    <div class="window-info">
                        <div class="window-title">Janela ${index + 1} de ${windows.length}</div>
                        <div class="window-status pending" id="status-${index}">‚è∏Ô∏è Aguardando</div>
                    </div>
                    <div class="window-preview">${window.substring(0, 150)}...</div>
                    <div class="window-actions">
                        <button class="window-button secondary" onclick="viewWindowText(${index})">
                            üìù Ver Texto
                        </button>
                        <button class="window-button primary" id="translate-${index}" onclick="translateWindow(${index})">
                            üîÑ Traduzir
                        </button>
                        <button class="window-button secondary" id="download-${index}" onclick="downloadWindow(${index})" disabled>
                            üì• Baixar
                        </button>
                    </div>
                    <div class="progress-bar" id="window-progress-${index}">
                        <div class="progress-fill" id="window-progress-fill-${index}"></div>
                    </div>
                `;
                list.appendChild(windowDiv);
            });

            container.classList.add('show');
            document.getElementById('translateButton').style.display = 'none';
            document.getElementById('resultSection').classList.remove('show');
        }

        // Ver texto da janela
        window.viewWindowText = function(index) {
            const text = textWindows[index];
            document.getElementById('textInput').value = text;
            document.getElementById('textInput').scrollIntoView({ behavior: 'smooth' });
        }

        // Traduzir janela espec√≠fica
        window.translateWindow = async function(index) {
            const text = textWindows[index];
            const apiKey = getApiKey();
            const sourceLang = document.getElementById('sourceLang').value;
            const targetLang = document.getElementById('targetLang').value;
            const style = document.getElementById('style').value;

            if (!apiKey) {
                showError(`Por favor, insira a chave API ${selectedProvider === 'anthropic' ? 'Anthropic' : 'OpenAI'}.`);
                return;
            }

            // Atualizar status
            const statusEl = document.getElementById(`status-${index}`);
            const translateBtn = document.getElementById(`translate-${index}`);
            const downloadBtn = document.getElementById(`download-${index}`);
            const progressBar = document.getElementById(`window-progress-${index}`);
            const progressFill = document.getElementById(`window-progress-fill-${index}`);

            statusEl.className = 'window-status processing';
            statusEl.textContent = 'üîÑ Processando...';
            translateBtn.disabled = true;
            progressBar.classList.add('show');

            try {
                // Obter chunk size apropriado
                const chunkSize = selectedProvider === 'anthropic' 
                    ? CHUNK_SIZES.anthropic 
                    : CHUNK_SIZES.openai[selectedModel];
                
                const chunks = smartSplitText(text, chunkSize);
                const translations = [];

                for (let i = 0; i < chunks.length; i++) {
                    const progress = ((i + 1) / chunks.length) * 100;
                    progressFill.style.width = progress + '%';
                    statusEl.textContent = `üîÑ Traduzindo parte ${i + 1}/${chunks.length}...`;

                    const translation = await callTranslationAPI(
                        apiKey,
                        chunks[i],
                        sourceLang,
                        targetLang,
                        style,
                        i,
                        chunks.length
                    );

                    if (translation) {
                        translations.push(translation);
                    }

                    // Pequeno delay entre chunks
                    if (i < chunks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }

                const fullTranslation = translations.join('\n\n');
                windowTranslations[index] = fullTranslation;

                statusEl.className = 'window-status completed';
                statusEl.textContent = '‚úÖ Conclu√≠da';
                downloadBtn.disabled = false;
                progressBar.classList.remove('show');

            } catch (error) {
                statusEl.className = 'window-status error';
                statusEl.textContent = '‚ùå Erro';
                showError(`Erro na janela ${index + 1}: ${error.message}`);
                progressBar.classList.remove('show');
            } finally {
                translateBtn.disabled = false;
            }
        }

        // Fun√ß√£o para obter API key correta
        function getApiKey() {
            if (selectedProvider === 'anthropic') {
                return document.getElementById('anthropicKey').value.trim();
            } else {
                return document.getElementById('openaiKey').value.trim();
            }
        }

        // Fun√ß√£o para dividir texto inteligentemente
        function smartSplitText(text, maxChunkSize) {
            if (text.length <= maxChunkSize) {
                return [text];
            }

            const chunks = [];
            const paragraphs = text.split(/\n\n+/);
            let currentChunk = '';

            for (const paragraph of paragraphs) {
                if (paragraph.length > maxChunkSize) {
                    if (currentChunk.trim()) {
                        chunks.push(currentChunk.trim());
                        currentChunk = '';
                    }

                    // Dividir par√°grafo grande por senten√ßas
                    const sentences = paragraph.match(/[^.!?]+[.!?]+/g) || [paragraph];
                    
                    for (const sentence of sentences) {
                        if (currentChunk.length + sentence.length > maxChunkSize && currentChunk) {
                            chunks.push(currentChunk.trim());
                            currentChunk = sentence;
                        } else {
                            currentChunk += sentence;
                        }
                    }
                } else if (currentChunk.length + paragraph.length + 2 > maxChunkSize) {
                    chunks.push(currentChunk.trim());
                    currentChunk = paragraph;
                } else {
                    currentChunk += (currentChunk ? '\n\n' : '') + paragraph;
                }
            }

            if (currentChunk.trim()) {
                chunks.push(currentChunk.trim());
            }

            return chunks;
        }

        async function translate() {
            const apiKey = getApiKey();
            const text = document.getElementById('textInput').value.trim();
            const sourceLang = document.getElementById('sourceLang').value;
            const targetLang = document.getElementById('targetLang').value;
            const style = document.getElementById('style').value;

            if (!apiKey) {
                showError(`Por favor, insira a chave API ${selectedProvider === 'anthropic' ? 'Anthropic' : 'OpenAI'}.`);
                return;
            }

            if (!text) {
                showError('Por favor, insira um texto ou fa√ßa upload de um arquivo.');
                return;
            }

            if (sourceLang === targetLang && sourceLang !== 'auto') {
                showError('Os idiomas de origem e destino s√£o iguais.');
                return;
            }

            // Verificar se deve usar modo janela
            if (text.length > WINDOW_SIZE) {
                const useWindows = confirm(
                    `Texto muito grande (${text.length.toLocaleString('pt-BR')} caracteres)!\n\n` +
                    `Recomendamos usar o modo janela para melhor controle.\n\n` +
                    `Deseja dividir em janelas menores?`
                );

                if (useWindows) {
                    const windows = createTextWindows(text, WINDOW_SIZE);
                    showWindows(windows);
                    return;
                }
            }

            hideError();
            hideWarning();
            document.getElementById('translateButton').disabled = true;
            document.getElementById('resultSection').classList.remove('show');
            
            translationStartTime = Date.now();
            abortController = new AbortController();

            try {
                const chunkSize = selectedProvider === 'anthropic' 
                    ? CHUNK_SIZES.anthropic 
                    : CHUNK_SIZES.openai[selectedModel];
                
                const chunks = smartSplitText(text, chunkSize);
                
                if (chunks.length > 1) {
                    showWarning(`‚ö†Ô∏è Texto dividido em ${chunks.length} partes para melhor processamento.`);
                    translatedText = await translateInChunks(apiKey, chunks, sourceLang, targetLang, style);
                } else {
                    showLoading(true, 'Traduzindo...');
                    translatedText = await callTranslationAPI(apiKey, text, sourceLang, targetLang, style);
                }
                
                if (translatedText) {
                    showResult(translatedText);
                } else {
                    throw new Error('Tradu√ß√£o retornou vazia');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showError('Tradu√ß√£o cancelada');
                } else {
                    showError('Erro na tradu√ß√£o: ' + error.message);
                }
            } finally {
                showLoading(false);
                hideProgressBar();
                document.getElementById('translateButton').disabled = false;
                abortController = null;
            }
        }

        async function translateInChunks(apiKey, chunks, sourceLang, targetLang, style) {
            const translations = [];
            showProgressBar();
            
            for (let i = 0; i < chunks.length; i++) {
                if (abortController.signal.aborted) {
                    throw new Error('Tradu√ß√£o cancelada');
                }

                const progress = ((i + 1) / chunks.length) * 100;
                updateProgress(progress, `Traduzindo parte ${i + 1} de ${chunks.length}...`);
                
                let retries = 2;
                let translated = null;
                
                while (retries > 0 && !translated) {
                    try {
                        translated = await callTranslationAPI(
                            apiKey, 
                            chunks[i], 
                            sourceLang, 
                            targetLang, 
                            style,
                            i,
                            chunks.length
                        );
                        
                        if (translated && translated.trim()) {
                            translations.push(translated);
                            console.log(`‚úì Parte ${i + 1} traduzida: ${translated.length} caracteres`);
                            break;
                        }
                    } catch (error) {
                        retries--;
                        console.error(`‚úó Erro na parte ${i + 1}, tentativas restantes: ${retries}`, error);
                        
                        if (retries > 0) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        } else {
                            translations.push(`[ERRO NA TRADU√á√ÉO DA PARTE ${i + 1}]`);
                        }
                    }
                }
                
                // Delay entre partes
                if (i < chunks.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            return translations.join('\n\n');
        }

        async function callTranslationAPI(apiKey, text, sourceLang, targetLang, style, partIndex, totalParts) {
            try {
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey,
                        text,
                        sourceLang,
                        targetLang,
                        style,
                        provider: selectedProvider,
                        model: selectedModel,
                        partIndex,
                        totalParts
                    }),
                    signal: abortController ? abortController.signal : undefined
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `Erro ${response.status}`);
                }

                if (!data.success || !data.translation) {
                    throw new Error('Resposta inv√°lida da API');
                }

                return data.translation;
            } catch (error) {
                console.error('Erro na API:', error);
                throw error;
            }
        }

        function showResult(text) {
            if (!text || text.trim() === '') {
                showError('Erro: A tradu√ß√£o retornou vazia.');
                return;
            }
            
            const cleanText = text.trim();
            
            document.getElementById('resultText').textContent = cleanText;
            translatedText = cleanText;
            document.getElementById('resultSection').classList.add('show');
            
            const translationTime = Math.round((Date.now() - translationStartTime) / 1000);
            const originalLength = document.getElementById('textInput').value.length;
            const translatedLength = cleanText.length;
            const ratio = (translatedLength / originalLength * 100).toFixed(0);
            
            document.getElementById('resultInfo').innerHTML = 
                `Original: ${originalLength.toLocaleString('pt-BR')} chars | ` +
                `Tradu√ß√£o: ${translatedLength.toLocaleString('pt-BR')} chars (${ratio}%) | ` +
                `Tempo: ${translationTime}s | ` +
                `API: ${selectedProvider === 'anthropic' ? 'Claude' : selectedModel}`;
            
            setTimeout(() => {
                document.getElementById('resultSection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }, 100);
        }

        // Fun√ß√µes para janelas
        window.downloadWindow = function(index) {
            const translation = windowTranslations[index];
            if (!translation) return;

            const blob = new Blob([translation], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            let fileName = `traducao_janela_${index + 1}.txt`;
            if (currentFileName) {
                const baseName = currentFileName.replace(/\.[^/.]+$/, '');
                fileName = `${baseName}_janela_${index + 1}.txt`;
            }
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        window.downloadAllWindows = function() {
            const translations = [];
            for (let i = 0; i < textWindows.length; i++) {
                if (windowTranslations[i]) {
                    translations.push(`=== JANELA ${i + 1} ===\n\n${windowTranslations[i]}`);
                }
            }

            if (translations.length === 0) {
                showError('Nenhuma janela foi traduzida ainda.');
                return;
            }

            const blob = new Blob([translations.join('\n\n\n')], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            let fileName = 'traducao_completa.txt';
            if (currentFileName) {
                const baseName = currentFileName.replace(/\.[^/.]+$/, '');
                fileName = `${baseName}_traduzido_completo.txt`;
            }
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        window.joinAllTranslations = function() {
            const translations = [];
            for (let i = 0; i < textWindows.length; i++) {
                if (windowTranslations[i]) {
                    translations.push(windowTranslations[i]);
                } else {
                    translations.push(`[JANELA ${i + 1} N√ÉO TRADUZIDA]`);
                }
            }

            const joinedText = translations.join('\n\n');
            translatedText = joinedText;
            
            // Mostrar na se√ß√£o de resultado
            document.getElementById('resultText').textContent = joinedText;
            document.getElementById('resultSection').classList.add('show');
            document.getElementById('windowsContainer').classList.remove('show');
            document.getElementById('translateButton').style.display = 'block';
            
            const originalLength = document.getElementById('textInput').value.length;
            const translatedLength = joinedText.length;
            const ratio = (translatedLength / originalLength * 100).toFixed(0);
            
            document.getElementById('resultInfo').innerHTML = 
                `Tradu√ß√£o unificada de ${textWindows.length} janelas | ` +
                `Total: ${translatedLength.toLocaleString('pt-BR')} chars (${ratio}%)`;
        }

        function updateProgress(percent, message) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = message;
        }

        function showProgressBar() {
            document.getElementById('progressBar').classList.add('show');
            document.getElementById('progressFill').style.width = '0%';
        }

        function hideProgressBar() {
            document.getElementById('progressBar').classList.remove('show');
        }

        function showWarning(message) {
            const warningEl = document.getElementById('warning');
            warningEl.textContent = message;
            warningEl.classList.add('show');
        }

        function hideWarning() {
            document.getElementById('warning').classList.remove('show');
        }

        function copyResult() {
            navigator.clipboard.writeText(translatedText).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copiado!';
                
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(() => {
                showError('Erro ao copiar. Tente selecionar e copiar manualmente.');
            });
        }

        function downloadTXT() {
            const content = translatedText;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            let fileName = 'traducao.txt';
            if (currentFileName) {
                const baseName = currentFileName.replace(/\.[^/.]+$/, '');
                fileName = `${baseName}_traduzido.txt`;
            }
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadHTML() {
            const htmlContent = convertToHTML(translatedText);
            const fullHTML = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradu√ß√£o - ${currentFileName || 'Documento'}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            color: #333;
        }
        h1, h2, h3, h4, h5, h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            line-height: 1.2;
        }
        p {
            margin-bottom: 1em;
        }
        blockquote {
            margin: 1em 0;
            padding-left: 1em;
            border-left: 3px solid #ddd;
            color: #666;
        }
        ul, ol {
            margin-bottom: 1em;
        }
        strong {
            font-weight: 600;
        }
        em {
            font-style: italic;
        }
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 2em 0;
        }
        .metadata {
            background: #f5f5f7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .metadata p {
            margin: 5px 0;
        }
        .error-marker {
            background: #ffeeee;
            color: #cc0000;
            padding: 10px;
            margin: 20px 0;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="metadata">
        <p><strong>Documento original:</strong> ${currentFileName || 'Texto inserido'}</p>
        <p><strong>Data da tradu√ß√£o:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
        <p><strong>API utilizada:</strong> ${selectedProvider === 'anthropic' ? 'Claude' : selectedModel}</p>
    </div>
    ${htmlContent}
</body>
</html>`;

            const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            let fileName = 'traducao.html';
            if (currentFileName) {
                const baseName = currentFileName.replace(/\.[^/.]+$/, '');
                fileName = `${baseName}_traduzido.html`;
            }
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadMarkdown() {
            const markdownContent = convertToMarkdown(translatedText);
            const fullContent = `# Tradu√ß√£o

**Documento original:** ${currentFileName || 'Texto inserido'}  
**Data:** ${new Date().toLocaleDateString('pt-BR')}  
**API:** ${selectedProvider === 'anthropic' ? 'Claude 3.5' : selectedModel}

---

${markdownContent}`;

            const blob = new Blob([fullContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            let fileName = 'traducao.md';
            if (currentFileName) {
                const baseName = currentFileName.replace(/\.[^/.]+$/, '');
                fileName = `${baseName}_traduzido.md`;
            }
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function convertToHTML(text) {
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Marcar erros de tradu√ß√£o
            html = html.replace(/\[ERRO NA TRADU√á√ÉO DA PARTE \d+\]/g, match => 
                `<div class="error-marker">${match}</div>`
            );

            html = html
                .replace(/^([A-Z][A-Z\s]+)$/gm, '<h2>$1</h2>')
                .replace(/^(.+)\n[=]+$/gm, '<h1>$1</h1>')
                .replace(/^(.+)\n[-]+$/gm, '<h2>$1</h2>')
                
                .split(/\n\n+/)
                .map(para => {
                    para = para.trim();
                    if (para.startsWith('<') || para === '') return para;
                    
                    if (para.match(/^[-*‚Ä¢]\s+/m)) {
                        const items = para.split(/\n/).map(line => 
                            line.replace(/^[-*‚Ä¢]\s+/, '<li>') + '</li>'
                        ).join('\n');
                        return `<ul>\n${items}\n</ul>`;
                    }
                    
                    if (para.match(/^\d+\.\s+/m)) {
                        const items = para.split(/\n/).map(line => 
                            line.replace(/^\d+\.\s+/, '<li>') + '</li>'
                        ).join('\n');
                        return `<ol>\n${items}\n</ol>`;
                    }
                    
                    if (para.match(/^[">]/)) {
                        return `<blockquote>${para}</blockquote>`;
                    }
                    
                    return `<p>${para}</p>`;
                })
                .join('\n\n');

            html = html
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/__([^_]+)__/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/_([^_]+)_/g, '<em>$1</em>');

            return html;
        }

        function convertToMarkdown(text) {
            let markdown = text;

            // Marcar erros
            markdown = markdown.replace(/\[ERRO NA TRADU√á√ÉO DA PARTE \d+\]/g, match => 
                `\n\n> ‚ö†Ô∏è **${match}**\n\n`
            );

            markdown = markdown
                .replace(/^([A-Z][A-Z\s]+)$/gm, '## $1')
                .replace(/^[-‚Ä¢]\s+/gm, '- ')
                .replace(/^\d+\.\s+/gm, (match, offset, string) => {
                    const lineStart = string.lastIndexOf('\n', offset - 1) + 1;
                    const lineNum = string.substring(0, offset).split(/^\d+\.\s+/m).length;
                    return `${lineNum}. `;
                });

            markdown = markdown
                .replace(/\n([A-Z])/g, '\n\n$1')
                .replace(/\n\n\n+/g, '\n\n');

            return markdown;
        }

        function showLoading(show, message = 'Traduzindo...') {
            const loadingEl = document.getElementById('loading');
            if (show) {
                document.getElementById('loadingText').textContent = message;
                loadingEl.classList.add('show');
            } else {
                loadingEl.classList.remove('show');
                document.getElementById('progressText').textContent = '';
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideError() {
            document.getElementById('error').classList.remove('show');
        }

        // Salvar e carregar API keys
        document.getElementById('anthropicKey').addEventListener('input', (e) => {
            localStorage.setItem('anthropic_api_key', e.target.value);
        });

        document.getElementById('openaiKey').addEventListener('input', (e) => {
            localStorage.setItem('openai_api_key', e.target.value);
        });

        // Salvar prefer√™ncia de estilo
        document.getElementById('style').addEventListener('change', (e) => {
            localStorage.setItem('translation_style', e.target.value);
        });

        // Cancelar tradu√ß√£o com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && abortController) {
                abortController.abort();
                showWarning('Tradu√ß√£o cancelada pelo usu√°rio');
            }
        });

        window.addEventListener('load', () => {
            const savedAnthropicKey = localStorage.getItem('anthropic_api_key');
            if (savedAnthropicKey) {
                document.getElementById('anthropicKey').value = savedAnthropicKey;
            }
            
            const savedOpenAIKey = localStorage.getItem('openai_api_key');
            if (savedOpenAIKey) {
                document.getElementById('openaiKey').value = savedOpenAIKey;
            }
            
            const savedStyle = localStorage.getItem('translation_style');
            if (savedStyle) {
                document.getElementById('style').value = savedStyle;
            }
            
            // Atualizar campos de API key
            updateApiKeyFields();
        });
    </script>
</body>
</html>
