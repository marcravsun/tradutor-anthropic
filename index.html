<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradutor de Documentos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            padding: 48px;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 48px;
            color: #1d1d1f;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            background: #f5f5f7;
            transition: all 0.2s;
        }

        input[type="password"]:focus {
            outline: none;
            border-color: #0071e3;
            background: white;
        }

        .language-selector {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            margin-bottom: 32px;
        }

        select {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }

        .help-text {
            font-size: 14px;
            color: #86868b;
            margin-top: 8px;
        }

        select:focus {
            outline: none;
            border-color: #0071e3;
        }

        .arrow {
            font-size: 20px;
            color: #86868b;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #d2d2d7;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 24px;
            background: #f5f5f7;
        }

        .upload-area:hover {
            border-color: #86868b;
            background: #ebebed;
        }

        .upload-area.dragover {
            border-color: #0071e3;
            background: #e8f2ff;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 8px;
            color: #86868b;
        }

        .upload-text {
            color: #1d1d1f;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .upload-formats {
            color: #86868b;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            background: #f5f5f7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .file-name {
            color: #1d1d1f;
            font-weight: 500;
        }

        .remove-file {
            background: none;
            border: none;
            color: #0071e3;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .remove-file:hover {
            background: #e8f2ff;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            font-size: 16px;
            font-family: inherit;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            background: #f5f5f7;
            resize: vertical;
            transition: all 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #0071e3;
            background: white;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #86868b;
            margin-top: 8px;
            margin-bottom: 32px;
        }

        .button {
            width: 100%;
            padding: 16px 32px;
            font-size: 17px;
            font-weight: 500;
            color: white;
            background: #0071e3;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 32px;
        }

        .button:hover:not(:disabled) {
            background: #0077ed;
        }

        .button:disabled {
            background: #86868b;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 32px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .loading p {
            margin: 10px 0;
            color: #495057;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f5f5f7;
            border-top-color: #0071e3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fff5f5;
            border: 1px solid #ff3b30;
            color: #ff3b30;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .result-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .result-actions {
            display: flex;
            gap: 12px;
        }

        .small-button {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-button {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .copy-button:hover {
            background: #e8e8ed;
        }

        .download-menu {
            position: relative;
            display: inline-block;
        }

        .download-options {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 8px;
            min-width: 150px;
            right: 0;
            top: 100%;
            margin-top: 4px;
            z-index: 10;
        }

        .download-options.show {
            display: block;
        }

        .download-option {
            display: block;
            padding: 8px 12px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            color: #1d1d1f;
            transition: background 0.2s;
        }

        .download-option:hover {
            background: #f5f5f7;
        }

        .format-preview {
            background: #f5f5f7;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            display: none;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }

        .format-preview.show {
            display: block;
        }

        .format-preview h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .format-preview pre {
            background: white;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }

        .result-text {
            background: #f5f5f7;
            border-radius: 8px;
            padding: 24px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 16px;
            line-height: 1.6;
        }

        .result-info {
            text-align: right;
            font-size: 14px;
            color: #86868b;
            margin-top: 8px;
        }

        footer {
            text-align: center;
            margin-top: 48px;
            padding-top: 24px;
            border-top: 1px solid #d2d2d7;
            color: #86868b;
            font-size: 14px;
        }

        footer a {
            color: #0071e3;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .container {
                padding: 32px 24px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 32px;
            }

            .language-selector {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tradutor de Documentos</h1>

        <div class="form-group">
            <label for="apiKey">Chave API Anthropic</label>
            <input 
                type="password" 
                id="apiKey" 
                placeholder="sk-ant-api03-..." 
                autocomplete="off"
            >
        </div>

        <div class="language-selector">
            <div>
                <label for="sourceLang">Idioma de origem</label>
                <select id="sourceLang">
                    <option value="auto">Detectar automaticamente</option>
                    <option value="pt-BR">Portugu√™s (Brasil)</option>
                    <option value="pt-PT">Portugu√™s (Portugal)</option>
                    <option value="en">Ingl√™s</option>
                    <option value="es">Espanhol</option>
                    <option value="fr">Franc√™s</option>
                    <option value="de">Alem√£o</option>
                    <option value="it">Italiano</option>
                    <option value="ja">Japon√™s</option>
                    <option value="ko">Coreano</option>
                    <option value="zh">Chin√™s</option>
                </select>
            </div>
            <div class="arrow">‚Üí</div>
            <div>
                <label for="targetLang">Idioma de destino</label>
                <select id="targetLang">
                    <option value="pt-BR" selected>Portugu√™s (Brasil)</option>
                    <option value="pt-PT">Portugu√™s (Portugal)</option>
                    <option value="en">Ingl√™s</option>
                    <option value="es">Espanhol</option>
                    <option value="fr">Franc√™s</option>
                    <option value="de">Alem√£o</option>
                    <option value="it">Italiano</option>
                    <option value="ja">Japon√™s</option>
                    <option value="ko">Coreano</option>
                    <option value="zh">Chin√™s</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="style">Estilo de tradu√ß√£o</label>
            <select id="style">
                <option value="intelligent" selected>Inteligente (Recomendada)</option>
                <option value="faithful">Fiel ao Original</option>
                <option value="fluent">Fluente e Natural</option>
                <option value="creative">Criativa e Liter√°ria</option>
                <option value="simplified">Simplificada</option>
                <option value="formal">Formal e Profissional</option>
                <option value="informal">Informal e Casual</option>
            </select>
            <p class="help-text" style="font-size: 14px; color: #86868b; margin-top: 8px;">
                üí° Inteligente: Captura TODOS os significados e transp√µe perfeitamente estilo, contexto e express√µes
            </p>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÑ</div>
            <p class="upload-text">Arraste um arquivo ou clique para selecionar</p>
            <p class="upload-formats">PDF, TXT, DOCX ‚Ä¢ M√°ximo 50MB</p>
            <input type="file" id="fileInput" accept=".pdf,.txt,.docx,.doc">
        </div>

        <div class="file-info" id="fileInfo">
            <span class="file-name" id="fileName"></span>
            <button class="remove-file" id="removeFileBtn">Remover</button>
        </div>

        <div class="form-group">
            <label for="textInput">Ou insira seu texto aqui</label>
            <textarea 
                id="textInput" 
                placeholder="Cole ou digite o texto que deseja traduzir..."
            ></textarea>
            <div class="char-count">
                <span id="charCount">0</span> caracteres
            </div>
        </div>

        <button class="button" id="translateButton">
            Traduzir
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Traduzindo...</p>
            <p style="font-size: 14px; color: #86868b;">
                <span id="progressText"></span>
            </p>
        </div>

        <div class="error" id="error"></div>

        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h3 class="result-title">Tradu√ß√£o</h3>
                <div class="result-actions">
                    <button class="small-button copy-button" id="copyBtn">
                        Copiar
                    </button>
                    <div class="download-menu">
                        <button class="small-button download-button" id="downloadBtn" style="background: #0071e3; color: white;">
                            Baixar ‚ñº
                        </button>
                        <div class="download-options" id="downloadOptions">
                            <button class="download-option" onclick="downloadHTML()">
                                üìÑ HTML Formatado
                            </button>
                            <button class="download-option" onclick="downloadMarkdown()">
                                üìù Markdown
                            </button>
                            <button class="download-option" onclick="downloadTXT()">
                                üìÉ Texto Simples
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="result-text" id="resultText"></div>
            <div class="result-info" id="resultInfo"></div>
            <div class="format-preview" id="formatPreview">
                <h3>Preview do formato:</h3>
                <pre id="previewContent"></pre>
            </div>
        </div>

        <footer>
            Powered by <a href="https://www.anthropic.com" target="_blank">Anthropic Claude</a>
        </footer>
    </div>

    <script>
        // Configura√ß√£o do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let extractedText = '';
        let translatedText = '';
        let currentFileName = '';
        let translationStartTime = 0;

        // Atualizar contador de caracteres
        document.getElementById('textInput').addEventListener('input', updateCharCount);

        function updateCharCount() {
            const text = document.getElementById('textInput').value;
            const charCount = text.length;
            document.getElementById('charCount').textContent = charCount.toLocaleString('pt-BR');
            
            // Estimativa de tempo
            let timeEstimate = '';
            if (charCount > 0) {
                if (charCount <= 10000) {
                    timeEstimate = ' ‚Ä¢ ~5 segundos';
                } else if (charCount <= 50000) {
                    timeEstimate = ' ‚Ä¢ ~30 segundos';
                } else if (charCount <= 100000) {
                    timeEstimate = ' ‚Ä¢ ~1 minuto';
                } else if (charCount <= 200000) {
                    timeEstimate = ' ‚Ä¢ ~2-3 minutos';
                } else {
                    timeEstimate = ' ‚Ä¢ ~5+ minutos';
                }
            }
            
            document.querySelector('.char-count').innerHTML = 
                `<span id="charCount">${charCount.toLocaleString('pt-BR')}</span> caracteres${timeEstimate}`;
        }

        // Configurar eventos dos bot√µes
        document.getElementById('translateButton').addEventListener('click', translate);
        document.getElementById('removeFileBtn').addEventListener('click', removeFile);
        document.getElementById('copyBtn').addEventListener('click', copyResult);
        
        // Menu de download
        document.getElementById('downloadBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('downloadOptions').classList.toggle('show');
        });

        // Fechar menu ao clicar fora
        document.addEventListener('click', function() {
            document.getElementById('downloadOptions').classList.remove('show');
        });

        // Configurar eventos de upload
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            // Validar tamanho do arquivo
            if (file.size > 50 * 1024 * 1024) {
                showError('Arquivo muito grande. O limite √© 50MB.');
                return;
            }

            // Validar tipo de arquivo
            const validTypes = ['application/pdf', 'text/plain', 
                               'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                               'application/msword'];
            
            if (!validTypes.includes(file.type) && !file.name.endsWith('.txt')) {
                showError('Tipo de arquivo n√£o suportado. Use PDF, TXT ou DOCX.');
                return;
            }

            currentFileName = file.name;
            showFileInfo(file.name);

            try {
                showLoading(true, 'Processando arquivo...');
                
                if (file.type === 'application/pdf') {
                    extractedText = await extractPDF(file);
                } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    extractedText = await extractTXT(file);
                } else if (file.type.includes('word') || file.name.endsWith('.docx')) {
                    extractedText = await extractDOCX(file);
                }

                document.getElementById('textInput').value = extractedText;
                updateCharCount();
                showLoading(false);
            } catch (error) {
                showError('Erro ao processar arquivo: ' + error.message);
                removeFile();
                showLoading(false);
            }
        }

        async function extractPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                showLoading(true, `Processando p√°gina ${i} de ${pdf.numPages}...`);
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // Melhor preserva√ß√£o de formata√ß√£o
                let lastY = null;
                let pageText = '';
                
                textContent.items.forEach(item => {
                    if (lastY !== null && Math.abs(lastY - item.transform[5]) > 5) {
                        pageText += '\n';
                    }
                    pageText += item.str + ' ';
                    lastY = item.transform[5];
                });
                
                fullText += pageText + '\n\n';
            }

            return fullText.trim();
        }

        async function extractTXT(file) {
            return await file.text();
        }

        async function extractDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        function showFileInfo(fileName) {
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileInfo').style.display = 'flex';
            document.getElementById('uploadArea').style.display = 'none';
        }

        function removeFile() {
            extractedText = '';
            currentFileName = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('textInput').value = '';
            fileInput.value = '';
            updateCharCount();
        }

        async function translate() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const text = document.getElementById('textInput').value.trim();
            const sourceLang = document.getElementById('sourceLang').value;
            const targetLang = document.getElementById('targetLang').value;
            const style = document.getElementById('style').value;

            console.log('API Key length:', apiKey.length); // DEBUG
            console.log('First 10 chars:', apiKey.substring(0, 10)); // DEBUG

            if (!apiKey) {
                showError('Por favor, insira sua chave API da Anthropic.');
                return;
            }

            if (!text) {
                showError('Por favor, insira um texto ou fa√ßa upload de um arquivo.');
                return;
            }

            if (sourceLang === targetLang && sourceLang !== 'auto') {
                showError('Os idiomas de origem e destino s√£o iguais.');
                return;
            }

            // Verificar tamanho do texto
            if (text.length > 100000) {
                if (!confirm('‚ö†Ô∏è Texto muito longo (' + Math.round(text.length/1000) + 'k caracteres)\n\nA tradu√ß√£o pode demorar 2-5 minutos.\n\nDeseja continuar?')) {
                    return;
                }
            } else if (text.length > 50000) {
                if (!confirm('Texto longo (' + Math.round(text.length/1000) + 'k caracteres)\n\nA tradu√ß√£o pode demorar 1-2 minutos.\n\nDeseja continuar?')) {
                    return;
                }
            }

            // Ajustar limite para for√ßar divis√£o em textos menores
            const chunkSize = 5000; // Reduzido de 10000 para 5000

            hideError();
            document.getElementById('translateButton').disabled = true;
            document.getElementById('resultSection').classList.remove('show');
            
            // Marcar in√≠cio da tradu√ß√£o
            translationStartTime = Date.now();

            // Adicionar timeout para evitar travamentos
            const timeoutId = setTimeout(() => {
                showError('A tradu√ß√£o est√° demorando muito. Tente um texto menor ou verifique sua conex√£o.');
                showLoading(false);
                document.getElementById('translateButton').disabled = false;
            }, 1200000); // 20 minutos de timeout!

            try {
                // Mostrar o estilo selecionado no loading
                const styleNames = {
                    'intelligent': 'Inteligente',
                    'faithful': 'Fiel',
                    'fluent': 'Fluente',
                    'creative': 'Criativa',
                    'simplified': 'Simplificada',
                    'formal': 'Formal',
                    'informal': 'Informal'
                };
                const loadingMessage = `Traduzindo (Estilo: ${styleNames[style]})...`;
                
                // Para textos muito grandes, dividir em chunks
                if (text.length > chunkSize) {
                    translatedText = await translateLargeText(apiKey, text, sourceLang, targetLang, style);
                } else {
                    showLoading(true, loadingMessage);
                    translatedText = await callAnthropicAPI(apiKey, text, sourceLang, targetLang, style);
                }
                
                showResult(translatedText);
                clearTimeout(timeoutId); // Limpar timeout se sucesso
            } catch (error) {
                clearTimeout(timeoutId); // Limpar timeout se erro
                if (error.message.includes('402')) {
                    showError('Erro 402: Cr√©ditos insuficientes na API. Verifique seu saldo em console.anthropic.com');
                } else if (error.message.includes('401')) {
                    showError('Erro 401: Chave API inv√°lida. Verifique se est√° correta.');
                } else if (error.message.includes('429')) {
                    showError('Erro 429: Muitas requisi√ß√µes. Aguarde um momento e tente novamente.');
                } else {
                    showError('Erro na tradu√ß√£o: ' + error.message);
                }
            } finally {
                showLoading(false);
                document.getElementById('translateButton').disabled = false;
            }
        }

        async function translateLargeText(apiKey, text, sourceLang, targetLang, style) {
            // Dividir texto preservando par√°grafos
            const chunks = [];
            const paragraphs = text.split(/\n\n+/);
            let currentChunk = '';
            
            for (const paragraph of paragraphs) {
                if ((currentChunk + paragraph).length > 10000) { // Reduzido de 30000
                    chunks.push(currentChunk);
                    currentChunk = paragraph;
                } else {
                    currentChunk += (currentChunk ? '\n\n' : '') + paragraph;
                }
            }
            if (currentChunk) chunks.push(currentChunk);
            
            // Traduzir cada chunk
            const translations = [];
            for (let i = 0; i < chunks.length; i++) {
                showLoading(true, `Traduzindo parte ${i + 1} de ${chunks.length}...`);
                try {
                    const translated = await callAnthropicAPI(apiKey, chunks[i], sourceLang, targetLang, style);
                    console.log(`Parte ${i + 1}: ${translated ? translated.length + ' chars' : 'VAZIA'}`);
                    if (translated && translated.trim()) {
                        translations.push(translated);
                    } else {
                        console.error(`Parte ${i + 1} retornou vazia!`);
                    }
                } catch (err) {
                    console.error(`Erro na parte ${i + 1}:`, err);
                    // Continua com as outras partes mesmo se uma falhar
                }
            }
            
            console.log(`Total de partes traduzidas: ${translations.length} de ${chunks.length}`);
            
            if (translations.length === 0) {
                throw new Error('Nenhuma parte foi traduzida com sucesso');
            }
            
            return translations.join('\n\n');
        }

        async function callAnthropicAPI(apiKey, text, sourceLang, targetLang, style) {
            try {
                console.log('Sending to API:', {
                    apiKeyLength: apiKey.length,
                    textLength: text.length,
                    sourceLang,
                    targetLang,
                    style
                });

                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey,
                        text,
                        sourceLang,
                        targetLang,
                        style
                    })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    throw new Error(data.error || 'Erro na tradu√ß√£o');
                }

                return data.translation;
            } catch (error) {
                console.error('Erro na API:', error);
                throw error;
            }
        }

        function showResult(text) {
            // Verificar se recebeu texto v√°lido
            if (!text || text.trim() === '') {
                showError('Erro: A tradu√ß√£o retornou vazia. Tente novamente ou use um texto menor.');
                return;
            }
            
            // Remover notas autom√°ticas do Claude sobre tradu√ß√£o parcial
            const cleanText = text
                .replace(/\[CONTINUA\.\.\.?\]/gi, '')
                .replace(/\n?Nota: Devido ao limite.*/gs, '')
                .replace(/\n?\[Nota: Esta √© uma tradu√ß√£o parcial.*/gs, '')
                .replace(/\n?Nota: Esta √© apenas.*/gs, '')
                .replace(/\[Continua traduzindo.*?\]/g, '')
                .replace(/\[Continua√ß√£o da tradu√ß√£o.*?\]/g, '')
                .replace(/\[Texto traduzido.*?\]/g, '')
                .replace(/\[.*?seguindo o mesmo padr√£o.*?\]/g, '')
                .replace(/\n\n+/g, '\n\n') // Limpar quebras de linha extras
                .trim();
            
            // Verificar se ainda tem conte√∫do ap√≥s limpeza
            if (!cleanText) {
                showError('Erro: A tradu√ß√£o foi processada mas retornou vazia.');
                return;
            }
            
            document.getElementById('resultText').textContent = cleanText;
            translatedText = cleanText; // Salvar texto limpo
            document.getElementById('resultSection').classList.add('show');
            
            // Calcular tempo de tradu√ß√£o
            const translationTime = Math.round((Date.now() - translationStartTime) / 1000);
            
            // Mostrar informa√ß√µes
            const charCount = cleanText.length;
            document.getElementById('resultInfo').innerHTML = 
                `${charCount.toLocaleString('pt-BR')} caracteres traduzidos ‚Ä¢ ${translationTime} segundos`;
            
            // Scroll suave at√© o resultado
            setTimeout(() => {
                document.getElementById('resultSection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }, 100);
        }

        function copyResult() {
            navigator.clipboard.writeText(translatedText).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copiado!';
                
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(() => {
                showError('Erro ao copiar. Tente selecionar e copiar manualmente.');
            });
        }

        function downloadResult() {
            downloadTXT(); // Comportamento padr√£o mantido
        }

        function downloadTXT() {
            const content = translatedText;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            let fileName = 'traducao.txt';
            if (currentFileName) {
                const baseName = currentFileName.replace(/\.[^/.]+$/, '');
                fileName = `${baseName}_traduzido.txt`;
            }
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadHTML() {
            const htmlContent = convertToHTML(translatedText);
            const fullHTML = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradu√ß√£o - ${currentFileName || 'Documento'}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            color: #333;
        }
        h1, h2, h3, h4, h5, h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            line-height: 1.2;
        }
        p {
            margin-bottom: 1em;
        }
        blockquote {
            margin: 1em 0;
            padding-left: 1em;
            border-left: 3px solid #ddd;
            color: #666;
        }
        ul, ol {
            margin-bottom: 1em;
        }
        strong {
            font-weight: 600;
        }
        em {
            font-style: italic;
        }
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 2em 0;
        }
        .metadata {
            background: #f5f5f7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .metadata p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="metadata">
        <p><strong>Documento original:</strong> ${currentFileName || 'Texto inserido'}</p>
        <p><strong>Data da tradu√ß√£o:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
        <p><strong>Traduzido por:</strong> Anthropic Claude</p>
    </div>
    ${htmlContent}
</body>
</html>`;

            const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            let fileName = 'traducao.html';
            if (currentFileName) {
                const baseName = currentFileName.replace(/\.[^/.]+$/, '');
                fileName = `${baseName}_traduzido.html`;
            }
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Mostrar preview
            showFormatPreview('HTML', fullHTML);
        }

        function downloadMarkdown() {
            const markdownContent = convertToMarkdown(translatedText);
            const fullContent = `# Tradu√ß√£o

**Documento original:** ${currentFileName || 'Texto inserido'}  
**Data:** ${new Date().toLocaleDateString('pt-BR')}  
**Traduzido por:** Anthropic Claude

---

${markdownContent}`;

            const blob = new Blob([fullContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            let fileName = 'traducao.md';
            if (currentFileName) {
                const baseName = currentFileName.replace(/\.[^/.]+$/, '');
                fileName = `${baseName}_traduzido.md`;
            }
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Mostrar preview
            showFormatPreview('Markdown', fullContent);
        }

        function convertToHTML(text) {
            // Escapar caracteres HTML
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Detectar e formatar estruturas
            html = html
                // T√≠tulos (linhas sozinhas em caps ou seguidas de sublinhado)
                .replace(/^([A-Z][A-Z\s]+)$/gm, '<h2>$1</h2>')
                .replace(/^(.+)\n[=]+$/gm, '<h1>$1</h1>')
                .replace(/^(.+)\n[-]+$/gm, '<h2>$1</h2>')
                
                // Par√°grafos
                .split(/\n\n+/)
                .map(para => {
                    para = para.trim();
                    if (para.startsWith('<h') || para === '') return para;
                    
                    // Listas
                    if (para.match(/^[-*‚Ä¢]\s+/m)) {
                        const items = para.split(/\n/).map(line => 
                            line.replace(/^[-*‚Ä¢]\s+/, '<li>') + '</li>'
                        ).join('\n');
                        return `<ul>\n${items}\n</ul>`;
                    }
                    
                    // Listas numeradas
                    if (para.match(/^\d+\.\s+/m)) {
                        const items = para.split(/\n/).map(line => 
                            line.replace(/^\d+\.\s+/, '<li>') + '</li>'
                        ).join('\n');
                        return `<ol>\n${items}\n</ol>`;
                    }
                    
                    // Cita√ß√µes (linhas come√ßando com > ou ")
                    if (para.match(/^[">]/)) {
                        return `<blockquote>${para}</blockquote>`;
                    }
                    
                    // Par√°grafos normais
                    return `<p>${para}</p>`;
                })
                .join('\n\n');

            // Formata√ß√£o inline
            html = html
                // Negrito
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/__([^_]+)__/g, '<strong>$1</strong>')
                // It√°lico
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/_([^_]+)_/g, '<em>$1</em>');

            return html;
        }

        function convertToMarkdown(text) {
            let markdown = text;

            // Detectar estruturas
            markdown = markdown
                // T√≠tulos (linhas em CAPS)
                .replace(/^([A-Z][A-Z\s]+)$/gm, '## $1')
                
                // Listas
                .replace(/^[-‚Ä¢]\s+/gm, '- ')
                .replace(/^\d+\.\s+/gm, (match, offset, string) => {
                    const lineStart = string.lastIndexOf('\n', offset - 1) + 1;
                    const lineNum = string.substring(0, offset).split(/^\d+\.\s+/m).length;
                    return `${lineNum}. `;
                });

            // Adicionar quebras de linha extras para melhor formata√ß√£o
            markdown = markdown
                .replace(/\n([A-Z])/g, '\n\n$1')
                .replace(/\n\n\n+/g, '\n\n');

            return markdown;
        }

        function showFormatPreview(format, content) {
            const preview = document.getElementById('formatPreview');
            const previewContent = document.getElementById('previewContent');
            
            preview.querySelector('h3').textContent = `Preview do ${format}:`;
            
            if (format === 'HTML') {
                // Mostrar c√≥digo HTML
                previewContent.textContent = content.substring(0, 1000) + '...';
            } else {
                previewContent.textContent = content.substring(0, 500) + '...';
            }
            
            preview.classList.add('show');
            
            // Auto-ocultar ap√≥s 5 segundos
            setTimeout(() => {
                preview.classList.remove('show');
            }, 5000);
        }

        function showLoading(show, message = 'Traduzindo...') {
            const loadingEl = document.getElementById('loading');
            if (show) {
                document.getElementById('loadingText').textContent = message;
                loadingEl.classList.add('show');
                
                // Atualizar progresso a cada 5 segundos
                let seconds = 0;
                const progressInterval = setInterval(() => {
                    seconds += 5;
                    const progressEl = document.getElementById('progressText');
                    if (seconds < 30) {
                        progressEl.textContent = 'Processando texto...';
                    } else if (seconds < 60) {
                        progressEl.textContent = 'Isto pode levar alguns momentos...';
                    } else {
                        progressEl.textContent = 'Texto longo - aguarde mais um pouco...';
                    }
                    
                    if (!loadingEl.classList.contains('show')) {
                        clearInterval(progressInterval);
                    }
                }, 5000);
                
                loadingEl.progressInterval = progressInterval;
            } else {
                if (loadingEl.progressInterval) {
                    clearInterval(loadingEl.progressInterval);
                }
                loadingEl.classList.remove('show');
                document.getElementById('progressText').textContent = '';
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            // Scroll para mostrar o erro
            errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Auto-ocultar ap√≥s 10 segundos (mais tempo para ler)
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 10000);
        }

        function hideError() {
            document.getElementById('error').classList.remove('show');
        }

        // Salvar e carregar API key
        document.getElementById('apiKey').addEventListener('input', (e) => {
            localStorage.setItem('anthropic_api_key', e.target.value);
        });

        // Salvar prefer√™ncia de estilo
        document.getElementById('style').addEventListener('change', (e) => {
            localStorage.setItem('translation_style', e.target.value);
        });

        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('anthropic_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
            
            const savedStyle = localStorage.getItem('translation_style');
            if (savedStyle) {
                document.getElementById('style').value = savedStyle;
            }
        });
    </script>
</body>
</html>
